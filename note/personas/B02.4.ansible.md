# é›†ç¾¤æ­å»º

* ç›®æ ‡
  * èƒ½å¤Ÿé€šè¿‡è‡ªåŠ¨åŒ–è„šæœ¬éƒ¨ç½²ä¸€ä¸ªé›†ç¾¤
* æ­¥éª¤
  1. ä¸ºä¼ä¸šè®¾è®¡ä¸€ä¸ªè§„æ¨¡åˆé€‚çš„é›†ç¾¤
  2. ä¼ä¸šä¸­éƒ¨ç½²å’Œç®¡ç†é›†ç¾¤çš„å·¥å…·
  3. è‡ªåŠ¨åˆ›å»ºè™šæ‹Ÿæœº
  4. è‡ªåŠ¨åŒ–éƒ¨ç½²æœåŠ¡
    
## 4. è‡ªåŠ¨åŒ–éƒ¨ç½²æœåŠ¡ (äº†è§£, è¿ç»´é¢†åŸŸ)



* ç›®æ ‡
  * èƒ½å¤Ÿé€šè¿‡è‡ªåŠ¨åŒ–è„šæœ¬å®‰è£… CM æœåŠ¡
* æ­¥éª¤
  1. ç—›ç‚¹å’Œ Ansible
  2. ä½¿ç”¨ Vagrant æ•´åˆ Ansible
  3. ç¦»çº¿å®‰è£… Ansible



### 4.1. ç—›ç‚¹å’Œ Ansible



å¥½äº†, æˆ‘ä»¬ç°åœ¨è¦å¼€å§‹å®‰è£… CM æœåŠ¡äº†, å¤§æ¦‚æœ‰å¦‚ä¸‹æ­¥éª¤



1. é…ç½®å¥½æ¯ä¸€å°æœºå™¨çš„ç³»ç»Ÿç¯å¢ƒ
   1. ä¿®æ”¹ä¸»æœºå
   2. å…³é—­é˜²ç«å¢™
   3. å…³é—­ SELinux
   4. å®‰è£… JDK
   5. å®‰è£… MySQL
   6. ... ä¸€ä¸Šåˆè¿‡å»äº†
2. åœ¨æ¯ä¸€å°æœºå™¨ä¸Šå®‰è£… SCM Agents
   1. Master 01 ä¸Šä¸‹è½½ Agents
   2. Worker 01ä¸Šä¸‹è½½ Agents
   3. Worker 02 ä¸Šä¸‹è½½ Angents
   4. é…ç½® Master 01
   5. é…ç½® Worker 01
   6. é…ç½® Worker 02
   7. å¯åŠ¨ Maser 01 çš„ Agents
   8. ... ä¸€å°æ—¶åˆè¿‡å»äº†, é€æ¸æ¼æ€’ ğŸ˜¡
3. åœ¨ Master 01 ä¸Šå®‰è£… SCM
   1. åˆ›å»º Linux ç”¨æˆ·, hadoop, hive, yarn, hdfs, oozie ç­‰æ‰€æœ‰æœåŠ¡éƒ½è¦æœ‰ä¸€ä¸ªç³»ç»Ÿç”¨æˆ·
   2. åˆ›å»º MySQL ç”¨æˆ·, å¤§æ¦‚å…­ä¸ƒä¸ª
   3. å®‰è£… SCM
   4. å¯åŠ¨
   5. æŠ¥é”™
   6. ... ä¸€ä¸‹åˆè¿‡å»äº†, è€å­ä¸å­¦ä¹ ! ğŸ˜¡ğŸ˜¡

4. å®‰è£… CDH ...



**å¥½äº†, è¿™äº›ç—›ç‚¹æˆ‘ä»¬éƒ½æ‡‚, äºæ˜¯å¼•å…¥ Ansible, Ansible éå¸¸é‡è¦, å‡ ä¹æ˜¯è¿ç»´é¢†åŸŸçš„é“¶å¼¹, ä½†æ˜¯å¦‚æœå¤§å®¶ä¸æ‰“ç®—åœ¨è¿ç»´é¢†åŸŸå‘å±•, äº†è§£å³å¯, Ansible å¯ä»¥å¸®åŠ©æˆ‘ä»¬åšå¦‚ä¸‹äº‹æƒ…**



* ä¸Šè¿°æ‰€æœ‰æ­¥éª¤, Ansible å¯ä»¥å¸®åŠ©æˆ‘ä»¬ä»¥é…ç½®çš„å½¢å¼ç¼–å†™
* Ansible å¯ä»¥å¸®åŠ©æˆ‘ä»¬åœ¨å¤šå°æœºå™¨ä¸Šæ‰§è¡Œé…ç½®æ–‡ä»¶è¡¨ç¤ºçš„è¿‡ç¨‹



**Ansible æœ‰å¦‚ä¸‹æ¦‚å¿µ**



| åç§°      | è§£é‡Š                                                         |
| :-------- | :----------------------------------------------------------- |
| Playbook  | å‰§æœ¬, æ˜¯ Ansible ä¸­çš„æ€»æ§, æ ¹é…ç½®æ–‡ä»¶<br>æ¯”å¦‚è¯´è¿™æ¬¡è¿è¡Œ Ansible çš„æœ€ç»ˆä»»åŠ¡æ˜¯æ­å»ºå¥½ä¸€ä¸ª CM é›†ç¾¤, é‚£æˆ‘ä»¬åº”è¯¥å°±æœ‰ä¸€ä¸ª Playbook å«åš `cm_playbook.yml` |
| Roles     | Ansible ä»»åŠ¡ä¸­çš„è§’è‰²<br>ä¾‹å¦‚ä¸ºäº†å®Œæˆ CM é›†ç¾¤çš„æ­å»º, å¯èƒ½è¦é…ç½®æ“ä½œç³»ç»Ÿ, é‚£åº”è¯¥å°±æŠŠé…ç½®æ“ä½œç³»ç»Ÿæ‰€éœ€è¦æ‰§è¡Œçš„æ‰€æœ‰é…ç½®éƒ½æ”¾åœ¨ä¸€ä¸ªå«åš `system_common` çš„ Roles ä¸­ |
| Inventory | Ansible ä¸­çš„æœåŠ¡å™¨åœ°å€é…ç½®<br>Ansible éœ€è¦åœ¨å¤šä¸ªä¸»æœºä¸­æ‰§è¡Œä»»åŠ¡, Inventory çš„ä½œç”¨å°±æ˜¯å‘Šè¯‰ Ansible ä¸»æœºçš„åœ°å€ç­‰ä¿¡æ¯ |



**é¦–å…ˆæ¥çœ‹çœ‹ PlayBook**



```yml
- name: Create hosts file in locally
  hosts: 192.168.56.101
  any_errors_fatal: True
  become: yes
  roles:
    - hosts

- name: Set yum locally
  hosts: cdh_cluster
  any_errors_fatal: True
  become: yes
  roles:
    - yum_locally
```


* nameï¼šæè¿°
* hostï¼šä¸»æœº
* any_errors_fatalï¼šæ˜¯å¦æŠ¥é”™ç»ˆæ­¢æ‰§è¡Œ
* becomeï¼šæ˜¯å¦ä½¿ç”¨rootç”¨æˆ·
* rolesï¼šæ‰§è¡Œçš„è§’è‰²  
* åœ¨ `192.168.56.101` ä¸­é…ç½® hosts æ–‡ä»¶
* åœ¨ `cdh_cluster` æ‰€å¯¹åº”çš„æœºå™¨ä¸­é…ç½®æœ¬åœ° Yum ä»“åº“

* `cdh_cluster` æ˜¯ä¸€ä¸ªåˆ†ç»„, è¿™ä¸ªåˆ†ç»„åœ¨ `Inventory` ä¸­é…ç½®
* `hosts` å’Œ `yum_locally` å°±æ˜¯è§’è‰²



**ç„¶åå†æ¥çœ‹çœ‹ Roles yum_locally**



```yml
- name: Set yum repo locally
  yum_repository:
    name: itcast-locally
    description: Local yum repo
    baseurl: http://master01/
    failovermethod: priority
    file: itcast
    priority: 1
    gpgcheck: no
    enabled: yes

- name: Clean yum meata
  command: yum clean all

```



* ç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯é€šè¿‡ Ansible æä¾›çš„ Yum repository æ’ä»¶, é…ç½®æœ¬åœ° Yum ä»“åº“
* ç¬¬äºŒä¸ªä»»åŠ¡æ˜¯æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ `yum clean all` æ¸…ç† Yum ç¼“å­˜



### 4.2. ä½¿ç”¨ Vagrant æ•´åˆ Ansible



Ansible æ˜¯ä¸€ä¸ªéå¸¸çŸ¥åçš„è‡ªåŠ¨åŒ–è¿ç»´å·¥å…·, ä¸ä»…ä»…åªæ˜¯ä¸ºäº†æ­å»ºæµ‹è¯•ç¯å¢ƒ, åœ¨æµ‹è¯•ç¯å¢ƒå’Œæ­£å¼ç¯å¢ƒä¸­, å…¶åº”ç”¨éƒ½å¾ˆå¹¿æ³›, **å…ˆæ¥çœ‹çœ‹åœ¨æ­£å¼ç¯å¢ƒä¸­è¯¥å¦‚ä½•ä½¿ç”¨ Ansible**



1. åœ¨ 13 å°æœºå™¨ä¸­, é€‰æ‹©ä¸€å°ä½œä¸ºä¸»æ§
2. åœ¨ä¸»æ§æœºå™¨ä¸­æ”¾å…¥ Ansible è„šæœ¬
3. æ‰§è¡Œå‘½ä»¤è¿è¡Œ Ansible, Ansible ä¼šåœ¨ Playbook ä¸­æ ‡ç¤ºçš„æœºå™¨ä¸Šè¿è¡Œ



```shell
ansible-playbook --inventory-file=/vagrant/inventory -v /vagrant/playbooks/cdh_cm.yml
```



æ˜ç™½äº†å¦‚ä½•åœ¨æ­£å¼ç¯å¢ƒä½¿ç”¨ Ansible ä»¥å, ä½¿ç”¨ Vagrant æ­å»ºæµ‹è¯•ç¯å¢ƒçš„æ—¶å€™ä¹Ÿå¯ä»¥ä½¿ç”¨ Ansible è„šæœ¬, Vagrant æä¾›äº†å¯¹åº”çš„ Provision



1. ç¼–å†™ Ansible playbook, æ–‡ä»¶åä¸º `testing.yml`

   ```yml
   - hosts: worker_servers
     tasks:
       debug:
         msg: "Hello from {{ inventory_hostname }}"
   ```

   

2. ç¼–å†™ Inventory, æ–‡ä»¶åä¸º `inventory`

   ```text
   [master_servers]
   master01 ansible_host=192.168.56.101 ansible_user=vagrant ansible_ssh_pass=vagrant
   
   [worker_servers]
   worker01 ansible_host=192.168.56.102 ansible_user=vagrant ansible_ssh_pass=vagrant
   worker02 ansible_host=192.168.56.103 ansible_user=vagrant ansible_ssh_pass=vagrant
   ```

   

3. ç¼–å†™ Vagrantfile

   ```ruby
   Vagrant.configure("2") do |config|
       config.ssh.password = "vagrant"
   
       config.vm.define "master01" do |master01|
           master01.vm.box = './pkgs/package.box'
           master01.disksize.size = '50GB'    
           master01.vm.network 'private_network', ip: '192.168.56.101'
           master01.vm.hostname = 'master01'
   
           master01.vm.provider 'virtualbox' do |vb|
               vb.gui = false
               vb.name = 'master01'
               vb.memory = 6000
               vb.cpus = 1
               vb.customize ["modifyvm", :id, "--cpuexecutioncap", "50"]
           end
       end
   
       config.vm.define "worker01" do |worker01|
           worker01.vm.box = './pkgs/package.box'
           worker01.disksize.size = '50GB'    
           worker01.vm.network 'private_network', ip: '192.168.56.102'
           worker01.vm.hostname = 'worker01'
   
           worker01.vm.provider 'virtualbox' do |vb|
               vb.gui = false
               vb.name = 'worker01'
               vb.memory = 2048
               vb.cpus = 1
               vb.customize ["modifyvm", :id, "--cpuexecutioncap", "50"]
           end
       end
   
       config.vm.define "worker02" do |worker02|
           worker02.vm.box = './pkgs/package.box'
           worker02.disksize.size = '50GB'    
           worker02.vm.network 'private_network', ip: '192.168.56.103'
           worker02.vm.hostname = 'worker02'
   
           worker02.vm.provider 'virtualbox' do |vb|
               vb.gui = false
               vb.name = 'worker02'
               vb.memory = 2048
               vb.cpus = 1
               vb.customize ["modifyvm", :id, "--cpuexecutioncap", "50"]
           end
       end
   
       config.vm.define "edge" do |edge|
           edge.vm.box = './pkgs/package.box'
           edge.disksize.size = '50GB'    
           edge.vm.network 'private_network', ip: '192.168.56.104'
           edge.vm.hostname = 'edge'
   
           edge.vm.provider 'virtualbox' do |vb|
               vb.gui = false
               vb.name = 'edge'
               vb.memory = 1024
               vb.cpus = 1
               vb.customize ["modifyvm", :id, "--cpuexecutioncap", "50"]
           end
   
           machine.vm.provision :ansible_local do |ansible|
               ansible.playbook       = "testing.yml"
               ansible.verbose        = true
               ansible.install        = true
               ansible.limit          = "all" # or only "nodes" group, etc.
               ansible.inventory_path = "inventory"
           end
       end
   end
   ```

   

4. è¿è¡ŒæŸ¥çœ‹ç»“æœ



å½“ç„¶, æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ Roles æ¥å°è£…ä¸€ä¸‹è¿™ä¸ªä»»åŠ¡



1. åˆ›å»º `roles/hello/tasks` ç›®å½•

2. ç¼–å†™ Roles

   ```yml
   - name: Hello
   	debug:
   		msg: "Hello from {{ inventory_hostname }}"
   ```

   

3. ä¿®æ”¹ Playbook

   ```yml
   - hosts: worker_servers
     roles:
     	- hello
   ```

   

### 4.3. ä½¿ç”¨ Ansible éƒ¨ç½² CM



è„šæœ¬å·²ç»ä¸ºå¤§å®¶ç¼–å†™å¥½äº†, å› ä¸ºå¤§å®¶åªéœ€è¦äº†è§£è¿™ä¸ªä¸œè¥¿, æ‰€ä»¥, ä¸å†æ·±å…¥å»è®², å¤§å®¶æœ‰å…´è¶£å¯ä»¥è‡ªè¡Œç ”ç©¶



1. ç¦»çº¿å®‰è£… Ansible
2. é…ç½® Hosts
3. é…ç½®ç¦»çº¿ Yum
4. ç¦»çº¿å®‰è£… MySQL
5. ...



### 4.4. å·²çŸ¥é—®é¢˜



#### å¯ä»¥è§£å†³çš„é—®é¢˜



* å¦‚æœåœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­, å‡ºç° scm æˆ–è€… scm agents å¼€å¤´çš„é”™è¯¯, å¯ä»¥ç”¨å¦‚ä¸‹çš„æ–¹å¼è§£å†³
  1. æ³¨é‡Šæ‰ cdh_cm.yml ä¸­çš„å‰åŠéƒ¨åˆ†ä»£ç , åœ¨ `Install cloudera agents` ä¹‹å‰çš„ä»£ç éƒ½æ³¨é‡Šæ‰
  2. vagrant ssh master01
     * å¯†ç æ˜¯ vagrant
  3. `PYTHONUNBUFFERED=1 ANSIBLE_FORCE_COLOR=true ansible-playbook --limit="all" --inventory-file=/vagrant/inventory -v /vagrant/playbooks/cdh_cm.yml`



* æˆåŠŸçš„è¡¨ç°

  * `Save import command id` å¼€å¤´çš„å‘½ä»¤æ‰§è¡Œå®Œæˆ, åˆ™æ„å‘³ç€æ•´ä¸ªé›†ç¾¤å·²ç»éƒ¨ç½²æˆåŠŸ

  * æ¥ä¸‹æ¥, æŸ¥çœ‹è¿›åº¦å³å¯

    1. æ‰“å¼€ `http://master01:7180`

    2. ç™»å½•, è´¦å·å¯†ç éƒ½æ˜¯ admin

    3. ç‚¹å‡»å³ä¸Šè§’1çš„å°å›¾æ ‡, æŸ¥çœ‹é›†ç¾¤éƒ¨ç½²æƒ…å†µ

       ![1582538805661](assets/1582538805661.png)



* Namenode å¯èƒ½æ ¼å¼åŒ–è¶…æ—¶, è¿™æ˜¯å› ä¸ºé›†ç¾¤èµ„æºä¸å¤Ÿ, éœ€è¦ç™»å½•åˆ° Master01 ä¸Šåˆ é™¤ `/dfs/nn`, ç„¶åé‡è¯•

  <img src="assets/image-20200221110159008.png" alt="image-20200221110159008" style="zoom:50%;" />

* Hive çš„ Metastore å’Œ Oozie çš„æ•°æ®åº“å¯èƒ½è¿æ¥è¶…æ—¶, ä¹Ÿæ˜¯å› ä¸ºé›†ç¾¤èµ„æºä¸å¤Ÿ, é‡è¯•å³å¯

  <img src="assets/image-20200221110234199.png" alt="image-20200221110234199" style="zoom:50%;" />

* Hive çš„ Schema æœ‰å¯èƒ½åˆ›å»ºå¤±è´¥, åŒæ ·å› ä¸ºé›†ç¾¤æ— æ³•å¹¶è¡Œå¤ªå¤šä»»åŠ¡çš„åŸå› , ç™»å…¥åˆ° master01 ä¸­, æ‰§è¡Œå¦‚ä¸‹æ­¥éª¤

  * ![1582542339828](assets/1582542339828.png)

  1. ç™»å…¥ MySQL, åˆ é™¤ metastore ä¸‹æ‰€æœ‰è¡¨, `mysql -uhive -ppassword`

     ```sql
     DROP TABLE IF EXISTS BUCKETING_COLS;
     DROP TABLE IF EXISTS CDS;
     DROP TABLE IF EXISTS COLUMNS_V2;
     DROP TABLE IF EXISTS DATABASE_PARAMS;
     DROP TABLE IF EXISTS DBS;
     DROP TABLE IF EXISTS DB_PRIVS;
     DROP TABLE IF EXISTS DELEGATION_TOKENS;
     DROP TABLE IF EXISTS FUNCS;
     DROP TABLE IF EXISTS GLOBAL_PRIVS;
     DROP TABLE IF EXISTS IDXS;
     DROP TABLE IF EXISTS INDEX_PARAMS;
     DROP TABLE IF EXISTS MASTER_KEYS;
     DROP TABLE IF EXISTS NUCLEUS_TABLES;
     DROP TABLE IF EXISTS PARTITIONS;
     DROP TABLE IF EXISTS PARTITION_EVENTS;
     DROP TABLE IF EXISTS PARTITION_KEYS;
     DROP TABLE IF EXISTS PARTITION_KEY_VALS;
     DROP TABLE IF EXISTS PARTITION_PARAMS;
     DROP TABLE IF EXISTS PART_COL_PRIVS;
     DROP TABLE IF EXISTS PART_COL_STATS;
     DROP TABLE IF EXISTS PART_PRIVS;
     DROP TABLE IF EXISTS ROLES;
     DROP TABLE IF EXISTS ROLE_MAP;
     DROP TABLE IF EXISTS SDS;
     DROP TABLE IF EXISTS SD_PARAMS;
     DROP TABLE IF EXISTS SEQUENCE_TABLE;
     DROP TABLE IF EXISTS SERDES;
     DROP TABLE IF EXISTS SERDE_PARAMS;
     DROP TABLE IF EXISTS SKEWED_COL_NAMES;
     DROP TABLE IF EXISTS SKEWED_COL_VALUE_LOC_MAP;
     DROP TABLE IF EXISTS SKEWED_STRING_LIST;
     DROP TABLE IF EXISTS SKEWED_STRING_LIST_VALUES;
     DROP TABLE IF EXISTS SKEWED_VALUES;
     DROP TABLE IF EXISTS SORT_COLS;
     DROP TABLE IF EXISTS TABLE_PARAMS;
     DROP TABLE IF EXISTS TAB_COL_STATS;
     DROP TABLE IF EXISTS TBLS;
     DROP TABLE IF EXISTS TBL_COL_PRIVS;
     DROP TABLE IF EXISTS TBL_PRIVS;
     DROP TABLE IF EXISTS TYPES;
     DROP TABLE IF EXISTS TYPE_FIELDS;
     DROP TABLE IF EXISTS VERSION;
     ```

  2. åœ¨ `/opt/cloudera/parcels/CDH/lib/hive/conf/hive-site.xml` ä¸­åŠ å…¥å¦‚ä¸‹

```xml
<property>
<name>javax.jdo.option.ConnectionUserName</name>
<value>hive</value>
</property>

<property>
<name>javax.jdo.option.ConnectionPassword</name>
<value>hive_password</value>
</property>

<property>
<name>javax.jdo.option.ConnectionURL</name>
<value>jdbc:mysql://master01:3306/metastore?useUnicode=true&amp;characterEncoding=UTF-8</value>
</property>

<property>
<name>javax.jdo.option.ConnectionDriverName</name>
<value>com.mysql.jdbc.Driver</value>
</property>
```

  3. æ‰§è¡Œä»»åŠ¡åˆå§‹åŒ– Hive metastore

     ```shell
     /opt/cloudera/parcels/CDH/lib/hive/bin/schematool -dbType mysql -initSchema
     ```

     

* Ansible æ‰§è¡Œå¯èƒ½åœ¨æœ€åä¸€æ­¥å¤±è´¥, è¿™æ˜¯å› ä¸ºå¯¼å…¥ CDH é›†ç¾¤æ˜¯ä¸€ä»¶è€—æ—¶çš„å·¥ä½œ, é‡è¯•çš„æ—¶é—´ä¸å¤Ÿ, è¿™ä¸ªé—®é¢˜æ— éœ€ç†ä¼š, ç™»å½• `master01:7180` æŸ¥çœ‹é›†ç¾¤çŠ¶æ€å³å¯, é»˜è®¤è´¦å·å’Œå¯†ç éƒ½æ˜¯ `admin`

  <img src="assets/image-20200221110413369.png" alt="image-20200221110413369" style="zoom: 50%;" />



**å¦‚æœå®åœ¨æ˜¯æœºå™¨çš„èµ„æºæœ‰é™, è¿è¡Œé€Ÿåº¦å¾ˆæ…¢, æˆ–è€…æ— æ³•æ‰§è¡Œ Yarn ä»»åŠ¡, æœ‰ä»¥ä¸‹ä¸¤ç§åšæ³•**



* å…³é—­ SCM æœ‰å…³æœåŠ¡, åªç•™ä¸‹ Hadoop ç›¸å…³æœåŠ¡

  ```shell
  systemctl stop cloudera-scm-agent
  systemctl stop cloudera-scm-server
  ```

  

* å…³é—­ Edge æœº

  ```shell
  vagrant destroy edge
  ```

  

#### æ— æ³•è§£å†³çš„é—®é¢˜



* å› ä¸º Master çš„å†…å­˜é…ç½®è¿‡ä½, æ‰€ä»¥ Hue çš„è¿è¡Œå—é™, æœ‰å¯èƒ½åœ¨ä¸Šä¼ å¤§æ–‡ä»¶æ—¶, è®¿é—® Oozie æ—¶, ä¼šå‡ºç°æ— å“åº”
* å› ä¸ºé›†ç¾¤æ•´ä½“èµ„æºå—é™, æ‰€ä»¥æ‰§è¡Œ Oozie ä»»åŠ¡æ—¶, å¯èƒ½ä¼šå‡ºç°æ— æ³•è°ƒåº¦çš„é—®é¢˜



è¿™äº›é—®é¢˜å…¶å®å¹¶ä¸æ˜¯é—®é¢˜, å½“ç»™é›†ç¾¤è¶³å¤Ÿèµ„æºæ—¶, è‡ªç„¶ä¼šè§£å†³, å¦‚æœæœ‰ 32G çš„å†…å­˜, å»ºè®®å¦‚ä¸‹åˆ†é…



* Master 01 åˆ†é… 12 G
* Workers åˆ†é… 8 G