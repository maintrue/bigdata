# 1 Impala安装部署

## 1.1 安装前提
集群提前安装好hadoop，hive。

hive安装包scp在所有需要安装impala的节点上，因为impala需要引用hive的依赖包。

hadoop框架需要支持C程序访问接口，查看下图，如果有该路径下有这么文件，就证明支持C接口。

![image](https://user-images.githubusercontent.com/75486726/184470322-d44e9eae-6de4-4172-bf29-2fded114d298.png)

## 1.2 下载安装包、依赖包
由于impala没有提供tar包进行安装，只提供了rpm包。因此在安装impala的时候，需要使用rpm包来进行安装。rpm包只有cloudera公司提供了，所以去cloudera公司网站进行下载rpm包即可。

但是另外一个问题，impala的rpm包依赖非常多的其他的rpm包，可以一个个的将依赖找出来，也可以将所有的rpm包下载下来，制作成我们本地yum源来进行安装。这里就选择制作本地的yum源来进行安装。

所以首先需要下载到所有的rpm包，下载地址如下

- http://archive.cloudera.com/cdh5/repo-as-tarball/5.14.0/cdh5.14.0-centos6.tar.gz

## 1.3 虚拟机新增磁盘（可选）
由于下载的cdh5.14.0-centos6.tar.gz包非常大，大概5个G，解压之后也最少需要5个G的空间。而我们的虚拟机磁盘有限，可能会不够用了，所以可以为虚拟机挂载一块新的磁盘，专门用于存储的cdh5.14.0-centos6.tar.gz包。

注意事项：新增挂载磁盘需要虚拟机保持在关机状态。

如果磁盘空间有余，那么本步骤可以省略不进行。

![image](https://user-images.githubusercontent.com/75486726/184470334-39a44cca-da1b-4ed2-9efa-1ca90a03dee9.png)

### 1.3.1 关机新增磁盘
虚拟机关机的状态下，在VMware当中新增一块磁盘。

![image](https://user-images.githubusercontent.com/75486726/184470344-f19db09c-ea0f-42d2-8d06-329f0d43289c.png)

![image](https://user-images.githubusercontent.com/75486726/184470355-c6937679-e607-4fa7-9d78-422df28ad55c.png)

![image](https://user-images.githubusercontent.com/75486726/184470361-4f5b8c8c-c811-438a-9cd9-f61d070c399d.png)

![image](https://user-images.githubusercontent.com/75486726/184470388-bb30268f-84d7-415e-8c04-47bfca81b83f.png)

![image](https://user-images.githubusercontent.com/75486726/184470399-02569d89-f389-4e78-8d0c-8872e3b150e5.png)


### 1.3.2 开机挂载磁盘
开启虚拟机，对新增的磁盘进行分区，格式化，并且挂载新磁盘到指定目录。
``` 
df -lh
```

![image](https://user-images.githubusercontent.com/75486726/184470410-76efb7da-23f8-447d-ae55-aaaa31603789.png)

``` 
fdisk -l
```

![image](https://user-images.githubusercontent.com/75486726/184470421-2cb05cdf-5a3b-4b40-b7f5-ca2525f9b4b7.png)

``` 
fdisk /dev/sdb
```

![image](https://user-images.githubusercontent.com/75486726/184470429-fef759bb-d78d-4146-b30d-309516cc6e2c.png)

``` 
fdisk -l
```

![image](https://user-images.githubusercontent.com/75486726/184470434-ab8f3eeb-a5cc-44c3-af0f-d93dcead1ecc.png)

下面对分区进行格式化操作：
``` 
mkfs -t ext4 -c /dev/sdb1
```

![image](https://user-images.githubusercontent.com/75486726/184470444-b09b6dd6-9b42-49a2-b4e7-c8e71b4f91e7.png)

创建挂载目录：
``` 
mount -t ext4 /dev/sdb1 /cloudera_data/
df -lh
```

![image](https://user-images.githubusercontent.com/75486726/184470459-5f0248c8-6113-4aa6-8a25-c2856f9fdb3f.png)

添加至开机自动挂载：
``` 
vim /etc/fstab
/dev/sdb1   /cloudera_data    ext4    defaults    0 0
```

![image](https://user-images.githubusercontent.com/75486726/184470469-66394174-3e63-4807-b58a-f331379cdeb3.png)

## 1.4 配置本地yum源

### 1.4.1 上传安装包解压
使用sftp的方式把安装包大文件上传到服务器/cloudera_data目录下。

![image](https://user-images.githubusercontent.com/75486726/184470475-bab95dfe-0331-4cd6-90b4-08a5b5401679.png)

``` 
cd /cloudera_data
tar -zxvf cdh5.14.0-centos6.tar.gz
```

### 1.4.2 配置本地yum源信息
安装Apache Server服务器
``` 
yum  -y install httpd
service httpd start
chkconfig httpd on
```

配置本地yum源的文件
``` 
cd /etc/yum.repos.d
vim localimp.repo

[localimp]
name=localimp
baseurl=http://node-3/cdh5.14.0/
gpgcheck=0
enabled=1
```

创建apache  httpd的读取链接
``` 
ln -s /cloudera_data/cdh/5.14.0 /var/www/html/cdh5.14.0
```


确保linux的Selinux关闭
``` 
临时关闭：
[root@localhost ~]# getenforce
Enforcing
[root@localhost ~]# setenforce 0
[root@localhost ~]# getenforce
Permissive
```

``` 
永久关闭：
[root@localhost ~]# vim /etc/sysconfig/selinux
SELINUX=enforcing 改为 SELINUX=disabled
重启服务reboot
```

通过浏览器访问本地yum源，如果出现下述页面则成功。
- http://192.168.227.153/cdh5.14.0/

![image](https://user-images.githubusercontent.com/75486726/184470491-e647ffea-547a-4abd-b488-90f19474dc5f.png)

将本地yum源配置文件localimp.repo发放到所有需要安装impala的节点。
``` 
cd /etc/yum.repos.d/
scp localimp.repo  node-2:$PWD
scp localimp.repo  node-3:$PWD
```

## 1.5 安装Impala

### 1.5.1 集群规划
服务名称从节点从节点主节点impala-catalog  Node-3impala-state-store  Node-3impala-server(impalad)Node-1Node-2Node-3

### 1.5.2 主节点安装
在规划的主节点node-3执行以下命令进行安装：

>注意：centos7需要安装两个依赖包
> 
> rpm -ivh https://ftp.nluug.nl/pub/os/Linux/distr/pclinuxos/pclinuxos/apt/pclinuxos/64bit/RPMS.x86_64/lib64python2.6-2.6.6-2pclos2011.x86_64.rpm
> 
> rpm -ivh https://ftp.nluug.nl/pub/os/Linux/distr/pclinuxos/pclinuxos/apt/pclinuxos/64bit/RPMS.x86_64/lib64sasl2-2.1.23-3pclos2013.x86_64.rpm

``` 
yum install -y impala impala-server impala-state-store impala-catalog impala-shell
```

### 1.5.3 从节点安装
在规划的从节点node-1、node-2执行以下命令进行安装：
``` 
yum install -y impala-server
```

## 1.6 修改Hadoop、Hive配置
需要在3台机器整个集群上进行操作，都需要修改。hadoop、hive是否正常服务并且配置好，是决定impala是否启动成功并使用的前提。

### 1.6.1 修改hive配置
可在node-1机器上进行配置，然后scp给其他2台机器。
``` 
vim /export/servers/hive/conf/hive-site.xml

<configuration>
  <property>
    <name>javax.jdo.option.ConnectionURL</name>  
    <value>jdbc:mysql://node-1:3306/hive?createDatabaseIfNotExist=true</value>
  </property>  
  <property>
    <name>javax.jdo.option.ConnectionDriverName</name>  
    <value>com.mysql.jdbc.Driver</value>
  </property>  
  <property>
    <name>javax.jdo.option.ConnectionUserName</name>  
    <value>root</value>
  </property>  
  <property>
    <name>javax.jdo.option.ConnectionPassword</name>  
    <value>hadoop</value>
  </property>  
  <property>
    <name>hive.cli.print.current.db</name>  
    <value>true</value>
  </property>  
  <property>
    <name>hive.cli.print.header</name>  
    <value>true</value>
  </property>  
  <!-- 绑定运行hiveServer2的主机host,默认localhost -->  
  <property>
    <name>hive.server2.thrift.bind.host</name>  
    <value>node-1</value>
  </property>  
  <!-- 指定hive metastore服务请求的uri地址 -->  
  <property>
    <name>hive.metastore.uris</name>  
    <value>thrift://node-1:9083</value>
  </property>  
  <property>
    <name>hive.metastore.client.socket.timeout</name>  
    <value>3600</value>
  </property>
</configuration>
```


将hive安装包cp给其他两个机器。
``` 
cd /export/servers/
scp -r hive/ node-2:$PWD
scp -r hive/ node-3:$PWD
```

### 1.6.2 修改hadoop配置
所有节点创建下述文件夹
``` 
mkdir -p /var/run/hdfs-sockets
```

修改所有节点的hdfs-site.xml添加以下配置，修改完之后重启hdfs集群生效
``` 
vim etc/hadoop/hdfs-site.xml

<property>
    <name>dfs.client.read.shortcircuit</name>
    <value>true</value>
</property>
<property>
    <name>dfs.domain.socket.path</name>
    <value>/var/run/hdfs-sockets/dn</value>
</property>
<property>
    <name>dfs.client.file-block-storage-locations.timeout.millis</name>
    <value>10000</value>
</property>
<property>
    <name>dfs.datanode.hdfs-blocks-metadata.enabled</name>
    <value>true</value>
</property>
```
> 配置解读：
>
> dfs.client.read.shortcircuit 打开DFSClient本地读取数据的控制，
> 
> dfs.domain.socket.path是Datanode和DFSClient之间沟通的Socket的本地路径。

把更新hadoop的配置文件，scp给其他机器。
``` 
cd /export/servers/hadoop-2.7.5/etc/hadoop
scp -r hdfs-site.xml node-2:$PWD
scp -r hdfs-site.xml node-3:$PWD
```

> 注意：root用户不需要下面操作，普通用户需要这一步操作。

给这个文件夹赋予权限，如果用的是普通用户hadoop，那就直接赋予普通用户的权限，例如：
``` 
chown  -R  hadoop:hadoop   /var/run/hdfs-sockets/
```
因为这里直接用的root用户，所以不需要赋权限了。

### 1.6.3 重启hadoop、hive
在node-1上执行下述命令分别启动hive metastore服务和hadoop。
```
cd  /export/servers/hive
mkdir log
nohup bin/hive --service metastore >> log/metastore.log 2>&1 &
nohup bin/hive --service hiveserver2 >> log/hiveserver2.log 2>&1 &

cd /export/servers/hadoop-2.7.5/
sbin/stop-dfs.sh  |  sbin/start-dfs.sh
```

### 1.6.4 复制hadoop、hive配置文件
impala的配置目录为/etc/impala/conf，这个路径下面需要把core-site.xml，hdfs-site.xml以及hive-site.xml。

所有节点执行以下命令
``` 
cp -r /export/servers/hadoop-2.7.5/etc/hadoop/core-site.xml /etc/impala/conf/core-site.xml
cp -r /export/servers/hadoop-2.7.5/etc/hadoop/hdfs-site.xml /etc/impala/conf/hdfs-site.xml
cp -r /export/servers/apache-hive-2.1.1-bin/conf/hive-site.xml /etc/impala/conf/hive-site.xml

```

## 1.7 修改impala配置

### 1.7.1 修改impala默认配置
所有节点更改impala默认配置文件
``` 
vi /etc/default/impala

IMPALA_CATALOG_SERVICE_HOST=server1
IMPALA_STATE_STORE_HOST=server1
```

### 1.7.2 添加mysql驱动
通过配置/etc/default/impala中可以发现已经指定了mysql驱动的位置名字。

![image](https://user-images.githubusercontent.com/75486726/184470526-918c8195-2554-4eb5-a6e8-1a95d59cc9f8.png)

使用软链接指向该路径即可（3台机器都需要执行）
``` 
ln -s /export/servers/hive/lib/mysql-connector-java-5.1.32.jar /usr/share/java/mysql-connector-java.jar
```

### 1.7.3 修改bigtop配置
修改bigtop的java_home路径（3台机器）
``` 
vim /etc/default/bigtop-utils
export JAVA_HOME=/export/servers/jdk1.8.0_65
```

## 1.8 启动、关闭impala服务
主节点node-3启动以下三个服务进程
``` 
service impala-state-store start
service impala-catalog start
service impala-server start
```

从节点启动node-1与node-2启动impala-server
``` 
service  impala-server  start
```

查看impala进程是否存在
``` 
ps -ef | grep impala
```

![image](https://user-images.githubusercontent.com/75486726/184470536-7a163c73-b6cf-4988-b813-52e2957f5a01.png)

启动之后所有关于impala的日志默认都在/var/log/impala

如果需要关闭impala服务 把命令中的start该成stop即可。注意如果关闭之后进程依然驻留，可以采取下述方式删除。正常情况下是随着关闭消失的。

解决方式：

![image](https://user-images.githubusercontent.com/75486726/184470546-1a848270-799d-4700-af91-13b805b67f1d.png)

### 1.8.1 impala web ui
访问impalad的管理界面：http://node-3:25000/

访问statestored的管理界面：http://node-3:25010/



